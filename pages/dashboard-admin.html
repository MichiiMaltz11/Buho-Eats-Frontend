<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Dashboard Admin - Buho Eats</title>
    
    <!-- Tailwind CSS (Offline) -->
    <script src="../libs/tailwind.js"></script>
    
    <!-- Configuraci√≥n de Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3D405B',
                        secondary: '#588B8B',
                        success: '#06BB0C',
                        danger: '#C11D0C',
                    }
                }
            }
        }
    </script>
    
    <!-- CSS personalizado -->
    <link rel="stylesheet" href="../assets/css/main.css">
    
    <style>
        /* Imagen de fondo con overlay oscuro */
        body {
            background-image: url('../assets/img/background.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
            position: relative;
        }
        
        /* Overlay oscuro semitransparente */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.2);
            z-index: -1;
        }
    
        /* Espacio para el header fijo */
        main {
            padding-top: 120px !important;
            min-height: calc(100vh - 120px);
        }

        /* Modal styles */
        #customDialog {
            display: none;
        }

        #customDialog:not(.hidden) {
            display: flex !important;
        }

        #customDialog.flex {
            display: flex !important;
        }

        /* Estilos para las cards de admin */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        }

        /* Estilos para botones */
        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }

        .btn-success {
            background-color: #06BB0C;
            color: white;
        }

        .btn-success:hover {
            background-color: #059a0a;
        }

        .btn-danger {
            background-color: #C11D0C;
            color: white;
        }

        .btn-danger:hover {
            background-color: #a01609;
        }

        .btn-muted {
            background-color: #6c757d;
            color: white;
        }

        .btn-muted:hover {
            background-color: #5a6268;
        }

        .btn.small {
            padding: 6px 12px;
            font-size: 14px;
        }

        /* Tabla de usuarios */
        .users-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .users-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .users-table th {
            background-color: #3D405B;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .users-table th:nth-child(1) { width: 20%; } /* Nombre */
        .users-table th:nth-child(2) { width: 25%; } /* Email */
        .users-table th:nth-child(3) { width: 10%; } /* Rol */
        .users-table th:nth-child(4) { width: 10%; } /* Strikes */
        .users-table th:nth-child(5) { width: 10%; } /* Activo */
        .users-table th:nth-child(6) { width: 25%; } /* Acciones */

        .users-table td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
            overflow: hidden;
            text-overflow: ellipsis;
            background-color: white;
        }

        .users-table tbody tr:hover td {
            background-color: #f9fafb;
        }

        .users-table tbody tr {
            transition: background-color 0.2s;
        }

        /* Contenedor de users-list con scroll solo en tbody */
        #users-list {
            width: 100%;
            max-height: 400px;
            overflow-y: auto;
            display: block;
        }

        #users-list table {
            display: table;
            width: 100%;
        }

        /* Reportes */
        .report {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            background: white;
        }

        .reports-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Cards de stats */
        #stats > div {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        #stats .text-sm {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 8px;
        }

        #stats .text-2xl {
            color: #3D405B;
            font-size: 32px;
            font-weight: bold;
        }

        /* Texto muted */
        .text-muted {
            color: #6b7280;
            font-size: 14px;
        }

        /* Restaurant cards */
        .restaurant-card {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            background: white;
        }

        .restaurant-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
    </style>
</head>
<body class="bg-gray-50" data-page="dashboard-admin">
    <!-- MODAL DE CONFIRMACI√ìN -->
    <div id="customDialog" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] hidden items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform transition-all">
            <!-- Header del modal -->
            <div class="p-6">
                <h3 id="dialogTitle" class="text-2xl font-bold text-primary">
                    <!-- T√≠tulo se agregar√° din√°micamente -->
                </h3>
            </div>
            
            <!-- Contenido del modal -->
            <div class="p-6">
                <p id="dialogMessage" class="text-gray-600">
                    <!-- Mensaje se agregar√° din√°micamente -->
                </p>
            </div>
            
            <!-- Botones del modal -->
            <div class="p-6 flex gap-3">
                <button 
                    id="dialogCancelBtn" 
                    class="flex-1 px-6 py-3 bg-danger text-white rounded-lg font-semibold hover:bg-danger/90 transition-all transform hover:scale-105"
                    onclick="closeDialog(false)"
                >
                    Cancelar
                </button>
                <button 
                    id="dialogConfirmBtn" 
                    class="flex-1 px-6 py-3 bg-success text-white rounded-lg font-semibold hover:bg-success/90 transition-all transform hover:scale-105"
                    onclick="closeDialog(true)"
                >
                    Aceptar
                </button>
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <div id="header-container">
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <main class="container mx-auto px-4 py-8">
        <!-- T√≠tulo -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-primary">Panel de Administraci√≥n</h1>
        </div>

        <!-- ESTAD√çSTICAS GENERALES -->
        <div class="mb-6">
            <h2 class="text-2xl font-bold text-primary mb-4">Estad√≠sticas Generales</h2>
            <div id="stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="text-center py-4">Cargando...</div>
            </div>
        </div>

        <!-- SECCIONES EN GRID -->
        <section id="admin-panels" class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            
            <!-- REPORTES DE RESE√ëAS -->
            <div id="reports-panel" class="col-span-1 lg:col-span-3 p-6 bg-white rounded-lg shadow-md">
                <div class="mb-4">
                    <h3 class="text-2xl font-bold text-primary">Reportes Pendientes</h3>
                </div>
                <div id="reports-list" class="max-h-80 overflow-y-auto">
                    <div class="text-gray-500">Cargando reportes...</div>
                </div>
            </div>

            <!-- GESTI√ìN DE USUARIOS -->
            <div id="users-panel" class="col-span-1 lg:col-span-3 p-6 bg-white rounded-lg shadow-md">
                <div class="mb-4">
                    <h3 class="text-2xl font-bold text-primary">Gesti√≥n de Usuarios</h3>
                </div>
                <div id="users-list">
                    <div class="text-gray-500">Cargando usuarios...</div>
                </div>
            </div>


        </section>

        <!-- GESTI√ìN DE RESTAURANTES -->
        <div class="mb-6">
            <div class="p-6 bg-white rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h2 class="text-2xl font-bold text-primary">Gesti√≥n de Restaurantes</h2>
                    </div>
                    <button onclick="loadRestaurants()" class="px-4 py-2 bg-secondary text-white rounded-lg hover:bg-secondary/90">
                        Refrescar
                    </button>
                </div>
                <div id="restaurants-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[500px] overflow-y-auto">
                    <div class="col-span-full text-center py-8 text-gray-500">Cargando restaurantes...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- FOOTER -->
    <div id="footer-container"></div>

    <!-- Scripts -->
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/utils.js"></script>
    <script src="../assets/js/main.js"></script>
    <script src="../assets/js/header.js"></script>
    <script src="../assets/js/api.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/restaurant-api.js"></script>
    <script src="../assets/js/carousel.js"></script>
    <script src="../assets/js/restaurant-card.js"></script>
    <script src="../assets/js/admin.js"></script>
    
    <script>
        let dialogCallback = null;

        function showDialog(options) {
            const dialog = document.getElementById('customDialog');
            const title = document.getElementById('dialogTitle');
            const message = document.getElementById('dialogMessage');
            const confirmBtn = document.getElementById('dialogConfirmBtn');
            const cancelBtn = document.getElementById('dialogCancelBtn');
            
            // Configurar contenido
            title.textContent = options.title || 'Confirmaci√≥n';
            message.textContent = options.message || '¬øEst√°s seguro?';
            confirmBtn.textContent = options.confirmText || 'Aceptar';
            cancelBtn.textContent = options.cancelText || 'Cancelar';
            
            // Guardar callbacks
            dialogCallback = {
                onConfirm: options.onConfirm || null,
                onCancel: options.onCancel || null
            };
            
            // Mostrar el di√°logo
            dialog.classList.remove('hidden');
            dialog.classList.add('flex');
            
            // Animaci√≥n de entrada
            setTimeout(() => {
                dialog.querySelector('.bg-white').classList.add('scale-100');
            }, 10);
        }

        function closeDialog(confirmed) {
            const dialog = document.getElementById('customDialog');
            
            // Animaci√≥n de salida
            dialog.querySelector('.bg-white').classList.remove('scale-100');
            
            setTimeout(() => {
                dialog.classList.add('hidden');
                dialog.classList.remove('flex');
                
                // Ejecutar callback correspondiente
                if (confirmed && dialogCallback?.onConfirm) {
                    dialogCallback.onConfirm();
                } else if (!confirmed && dialogCallback?.onCancel) {
                    dialogCallback.onCancel();
                }
                
                dialogCallback = null;
            }, 200);
        }

        // Cerrar con ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const dialog = document.getElementById('customDialog');
                if (!dialog.classList.contains('hidden')) {
                    closeDialog(false);
                }
            }
        });

        // Funci√≥n de logout - sobrescribe la de auth.js para agregar el di√°logo
        function logout() {
            showDialog({
                title: 'Cerrar Sesi√≥n',
                message: '¬øEst√°s seguro de que deseas cerrar sesi√≥n?',
                confirmText: 'Aceptar',
                cancelText: 'Cancelar',
                onConfirm: function() {
                    Auth.logout().catch(err => console.error('Error en logout:', err));
                }
            });
        }

        // Datos de restaurantes (se cargar√°n desde la API)
        window.restaurants = [];
        window.isLoadingRestaurants = false;

        /**
         * Cargar restaurantes desde la API (usando ruta admin para obtener owner)
         */
        async function loadRestaurants(filters = {}) {
            try {
                window.isLoadingRestaurants = true;
                showLoadingState();

                console.log('Cargando restaurantes desde API admin...');
                // Usar la ruta admin que incluye informaci√≥n del owner
                const token = await Auth.getToken();
                const response = await fetch(`${CONFIG.API_URL}/admin/restaurants`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                console.log('Respuesta recibida:', result);
                
                if (result.success) {
                    // Cargar favoritos del usuario
                    let userFavorites = [];
                    
                    // Verificar si est√° autenticado
                    if (Auth.isAuthenticated()) {
                        try {
                            // Obtener token desencriptado
                            const token = await Auth.getToken();
                            if (token) {
                                const favResponse = await fetch(`${CONFIG.API_URL}/favorites`, {
                                    headers: {
                                        'Authorization': `Bearer ${token}`
                                    }
                                });
                                if (favResponse.ok) {
                                    const favData = await favResponse.json();
                                    if (favData.success && favData.data) {
                                        userFavorites = favData.data.map(fav => fav.id);
                                    }
                                }
                            }
                        } catch (error) {
                            console.log('No se pudieron cargar favoritos (usuario no autenticado?)');
                        }
                    }
                    
                    // Verificar si tiene la estructura correcta (admin devuelve data.data)
                    if (result.data && result.data.data) {
                        console.log('Estructura admin correcta, mapeando datos...');
                        
                        // Mapear los datos de la API al formato que usa el frontend
                        window.restaurants = result.data.data.map(restaurant => {
                            let imageUrl = '../assets/img/restaurants/default/burger-1.jpg';
                            if (restaurant.image_url) {
                                if (restaurant.image_url.startsWith('http')) {
                                    imageUrl = restaurant.image_url;
                                } else {
                                    // Construir URL completa: http://localhost:3000/uploads/...
                                    const baseUrl = CONFIG.API_URL.replace('/api', '');
                                    imageUrl = baseUrl + restaurant.image_url;
                                }
                            }
                            
                            return {
                                id: restaurant.id,
                                name: restaurant.name,
                                category: restaurant.cuisine_type || 'Sin categor√≠a',
                                rating: restaurant.rating || restaurant.average_rating || 0,
                                image: imageUrl,
                                image_url: imageUrl,
                                reviews: restaurant.total_reviews || 0,
                                isFavorite: userFavorites.includes(restaurant.id),
                                is_active: restaurant.is_active,
                                // Datos del owner
                                owner_first: restaurant.owner_first,
                                owner_last: restaurant.owner_last,
                                owner_email: restaurant.owner_email,
                                owner_name: `${restaurant.owner_first || ''} ${restaurant.owner_last || ''}`.trim(),
                                // Datos adicionales
                                description: restaurant.description,
                                address: restaurant.address,
                                phone: restaurant.phone,
                                price_range: restaurant.price_range,
                                opening_hours: restaurant.opening_hours
                            };
                        });

                        console.log(`${window.restaurants.length} restaurantes cargados`);
                        console.log('Primer restaurante:', window.restaurants[0]);
                        console.log('Imagen del primer restaurante:', window.restaurants[0]?.image);

                        // Limpiar contenedor antes de renderizar
                        const container = document.getElementById('restaurants-list');
                        if (container) {
                            container.innerHTML = '';
                        }

                        // Renderizar usando la funci√≥n de admin.js con el array correcto
                        if (window.renderRestaurants) {
                            console.log('Llamando a renderRestaurants con', window.restaurants.length, 'restaurantes');
                            window.renderRestaurants(window.restaurants, true);
                        } else {
                            console.error('window.renderRestaurants no est√° disponible');
                        }
                        hideLoadingState();
                    } else {
                        // Si la respuesta no tiene data.restaurants, intentar con la estructura alternativa
                        console.warn('Estructura alternativa detectada');
                        if (response.restaurants) {
                            window.restaurants = response.restaurants.map(restaurant => {
                                let imageUrl = '../assets/img/restaurants/default/burger-1.jpg';
                                if (restaurant.image_url) {
                                    if (restaurant.image_url.startsWith('http')) {
                                        imageUrl = restaurant.image_url;
                                    } else {
                                        const baseUrl = CONFIG.API_URL.replace('/api', '');
                                        imageUrl = baseUrl + restaurant.image_url;
                                    }
                                }
                                
                                return {
                                    id: restaurant.id,
                                    name: restaurant.name,
                                    category: restaurant.cuisine_type || 'Sin categor√≠a',
                                    rating: restaurant.rating || restaurant.average_rating || 0,
                                    image: imageUrl,
                                    image_url: imageUrl,
                                    reviews: restaurant.total_reviews || 0,
                                    isFavorite: userFavorites.includes(restaurant.id)
                                };
                            });
                            
                            console.log(`${window.restaurants.length} restaurantes cargados (estructura alternativa)`);
                            
                            // Renderizar usando la funci√≥n de admin.js
                            if (window.renderRestaurants) {
                                window.renderRestaurants(window.restaurants, true);
                            }
                            hideLoadingState();
                        } else {
                            throw new Error('Estructura de respuesta no reconocida');
                        }
                    }
                } else {
                    throw new Error(response.message || response.error || 'Error desconocido al cargar restaurantes');
                }
            } catch (error) {
                console.error('Error cargando restaurantes:', error);
                showError('No se pudieron cargar los restaurantes. ' + error.message);
                hideLoadingState();
            } finally {
                window.isLoadingRestaurants = false;
            }
        }

        /**
         * Mostrar estado de carga
         */
        function showLoadingState() {
            const grid = document.getElementById('restaurants-list');
            if (grid) {
                grid.innerHTML = `
                    <div class="col-span-full flex flex-col items-center justify-center py-12">
                        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-secondary mb-4"></div>
                        <p class="text-gray-600 text-lg">Cargando restaurantes...</p>
                    </div>
                `;
            }
        }

        /**
         * Ocultar estado de carga
         */
        function hideLoadingState() {
            // El renderRestaurants() se encargar√° de mostrar el contenido
        }

        /**
         * Mostrar mensaje de error
         */
        function showError(message) {
            const grid = document.getElementById('restaurants-list');
            if (grid) {
                grid.innerHTML = `
                    <div class="col-span-full bg-red-50 border-2 border-red-200 rounded-lg p-6 text-center">
                        <svg class="w-12 h-12 text-red-500 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <h3 class="text-xl font-bold text-red-700 mb-2">Error al cargar restaurantes</h3>
                        <p class="text-red-600">${message}</p>
                        <button 
                            onclick="loadRestaurants()" 
                            class="mt-4 px-6 py-2 bg-secondary text-white rounded-lg hover:bg-secondary/90 transition"
                        >
                            Reintentar
                        </button>
                    </div>
                `;
            }
        }

        
        let currentPage = 1;
        const itemsPerPage = 6;
        let totalPages = Math.ceil(window.restaurants.length / itemsPerPage);

        function showSearchResults() {
            const dropdown = document.getElementById('searchDropdown');
            const searchInput = document.getElementById('searchInput');
            
           
        }
        
        // Cerrar dropdown si se hace clic fuera
        document.addEventListener('click', function(event) {
            const searchInput = document.getElementById('searchInput');
            const dropdown = document.getElementById('searchDropdown');
            
            if (searchInput && dropdown && !searchInput.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.add('hidden');
            }
        });
        
        function searchRestaurants() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const searchResults = document.getElementById('searchResults');
            const dropdown = document.getElementById('searchDropdown');
            
            dropdown.classList.remove('hidden');
            
            // Si no hay t√©rmino de b√∫squeda, mostrar mensaje
            if (!searchTerm) {
                searchResults.innerHTML = '<p class="text-gray-500 text-center py-4">Escribe para buscar restaurantes</p>';
                return;
            }
            
            // Filtrar solo por nombre
            const results = window.restaurants.filter(restaurant => 
                restaurant.name.toLowerCase().includes(searchTerm)
            );
            
            // Mostrar resultados en el dropdown
            if (results.length === 0) {
                searchResults.innerHTML = '<p class="text-gray-500 text-center py-4">No se encontraron restaurantes</p>';
            } else {
                searchResults.innerHTML = results.slice(0, 5).map(restaurant => `
                    <div 
                        onclick="goToRestaurantFromSearch(${restaurant.id})"
                        class="flex items-center gap-3 p-3 hover:bg-gray-100 rounded-lg cursor-pointer transition"
                    >
                        <img src="${restaurant.image}" alt="${restaurant.name}" class="w-16 h-16 object-cover rounded-lg" onerror="this.src='https://via.placeholder.com/64/3D405B/FFFFFF?text=üçΩÔ∏è'">
                        <div class="flex-1">
                            <h4 class="font-bold text-primary">${restaurant.name}</h4>
                            <p class="text-sm text-gray-600">${restaurant.category}</p>
                            <div class="flex items-center gap-1 mt-1">
                                <span class="text-yellow-400">‚≠ê</span>
                                <span class="text-sm font-semibold">${restaurant.rating.toFixed(1)}</span>
                                <span class="text-sm text-gray-500">(${restaurant.reviews})</span>
                            </div>
                        </div>
                        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </div>
                `).join('');
                
                // Si hay m√°s de 5 resultados, mostrar enlace para ver todos
                if (results.length > 5) {
                    searchResults.innerHTML += `
                        <div class="p-3 text-center border-t">
                            <button 
                                onclick="searchAllRestaurants('${searchTerm}')"
                                class="text-secondary font-semibold hover:underline"
                            >
                                Ver todos los ${results.length} resultados
                            </button>
                        </div>
                    `;
                }
            }
        }
        
        /**
         * Buscar todos los restaurantes y filtrar en el grid principal
         */
        function searchAllRestaurants(searchTerm) {
            const dropdown = document.getElementById('searchDropdown');
            dropdown.classList.add('hidden');
            
            // Filtrar solo por nombre
            const filtered = window.restaurants.filter(restaurant => 
                restaurant.name.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            if (filtered.length > 0) {
                currentPage = 1;
                renderRestaurantCards(filtered, 'restaurantsGrid');
                
                // Actualizar info de paginaci√≥n
                document.getElementById('showingStart').textContent = 1;
                document.getElementById('showingEnd').textContent = filtered.length;
                document.getElementById('totalRestaurants').textContent = filtered.length;
                
                // Scroll al grid
                document.getElementById('restaurantsal gridGrid').scrollIntoView({ behavior: 'smooth' });
            }
        }
        
        function goToRestaurantFromSearch(id) {
            window.location.href = `restaurant-detail.html?id=${id}`;
        }



        function updatePaginationInfo() {
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentPage * itemsPerPage, window.restaurants.length);
            
            document.getElementById('showingStart').textContent = window.restaurants.length > 0 ? startIndex : 0;
            document.getElementById('showingEnd').textContent = endIndex;
            document.getElementById('totalRestaurants').textContent = window.restaurants.length;
        }

        function updatePaginationButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const pageNumbers = document.getElementById('pageNumbers');
            
            // Bot√≥n anterior
            if (currentPage === 1) {
                prevBtn.disabled = true;
                prevBtn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                prevBtn.classList.remove('bg-secondary', 'text-white', 'hover:bg-secondary/90');
            } else {
                prevBtn.disabled = false;
                prevBtn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                prevBtn.classList.add('bg-secondary', 'text-white', 'hover:bg-secondary/90');
            }
            
            // Bot√≥n siguiente
            if (currentPage === totalPages) {
                nextBtn.disabled = true;
                nextBtn.classList.add('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                nextBtn.classList.remove('bg-secondary', 'text-white', 'hover:bg-secondary/90');
            } else {
                nextBtn.disabled = false;
                nextBtn.classList.remove('bg-gray-300', 'text-gray-500', 'cursor-not-allowed');
                nextBtn.classList.add('bg-secondary', 'text-white', 'hover:bg-secondary/90');
            }
            
            // N√∫meros de p√°gina
            pageNumbers.innerHTML = '';
            for (let i = 1; i <= totalPages; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToPage(i);
                pageBtn.className = `w-10 h-10 rounded-lg transition ${
                    i === currentPage 
                        ? 'bg-primary text-white' 
                        : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                }`;
                pageNumbers.appendChild(pageBtn);
            }
        }

        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                renderRestaurants();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                renderRestaurants();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function goToPage(page) {
            currentPage = page;
            renderRestaurants();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function goToRestaurant(id) {
            // Por ahora solo muestra una alerta, luego redirigir√° a la p√°gina de detalles
            window.location.href = `restaurant-detail.html?id=${id}`;
        }

        // Escuchar cambios en favoritos
        window.addEventListener('favoritesChanged', function(event) {
            const { restaurantId, isFavorite } = event.detail;
            
            // Actualizar el estado en el array de restaurantes
            const restaurant = window.restaurants?.find(r => r.id === restaurantId);
            if (restaurant) {
                restaurant.isFavorite = isFavorite;
                
                // Re-renderizar solo si estamos en la vista actual
                renderRestaurants();
            }
        });

        // Toggle de paneles
        function togglePanel(panelId) {
            const panel = document.getElementById(panelId);
            const isHidden = panel.style.display === 'none';
            panel.style.display = isHidden ? 'block' : 'none';
            
            // Cambiar √≠cono de flecha
            const button = panel.querySelector('button[onclick*="togglePanel"]');
            const svg = button?.querySelector('svg path');
            if (svg) {
                if (isHidden) {
                    svg.setAttribute('d', 'M5 15l7-7 7 7'); // Flecha hacia arriba
                } else {
                    svg.setAttribute('d', 'M19 9l-7 7-7-7'); // Flecha hacia abajo
                }
            }
            
            // Actualizar visibilidad del bot√≥n "Mostrar Todo"
            updateShowAllButton();
        }

        // Actualizar visibilidad del bot√≥n "Mostrar Todo"
        function updateShowAllButton() {
            const usersPanel = document.getElementById('users-panel');
            const statsPanel = document.getElementById('stats-panel');
            const showAllBtn = document.getElementById('showAllBtn');
            
            // Mostrar bot√≥n si alg√∫n panel est√° oculto
            const hasHiddenPanels = usersPanel.style.display === 'none' || statsPanel.style.display === 'none';
            
            if (hasHiddenPanels) {
                showAllBtn.style.display = 'block';
            } else {
                showAllBtn.style.display = 'none';
            }
        }

        // Mostrar todos los paneles
        function showAllPanels() {
            const panels = ['reports-panel', 'users-panel', 'stats-panel'];
            panels.forEach(panelId => {
                const panel = document.getElementById(panelId);
                if (panel) {
                    panel.style.display = 'block';
                    // Actualizar flecha a "arriba"
                    const svg = panel.querySelector('button[onclick*="togglePanel"] svg path');
                    if (svg) svg.setAttribute('d', 'M5 15l7-7 7 7');
                }
            });
            
            // Ocultar el bot√≥n
            updateShowAllButton();
        }

        // Cargar datos del dashboard
        async function loadStats() {
            try {
                const res = await (window.fetchJSON ? await window.fetchJSON('/api/admin/stats') : fetch(CONFIG.API_URL + '/admin/stats', {
                    headers: { 'Authorization': 'Bearer ' + await Auth.getToken() }
                }).then(r => r.json()));
                
                console.log('Respuesta de stats:', res);
                
                if (res && res.data) {
                    window.renderStats ? window.renderStats(res.data) : console.log('Stats:', res.data);
                }
            } catch (error) {
                console.error('Error cargando stats:', error);
            }
        }

        async function loadReports() {
            try {
                const res = await (window.fetchJSON ? await window.fetchJSON('/api/admin/reports?status=pendiente') : fetch(CONFIG.API_URL + '/admin/reports?status=pendiente', {
                    headers: { 'Authorization': 'Bearer ' + await Auth.getToken() }
                }).then(r => r.json()));
                
                console.log('Respuesta de reportes:', res);
                
                if (res && res.data) {
                    const reportsList = res.data.data || res.data || [];
                    window.renderReports ? window.renderReports(reportsList) : console.log('Reports:', reportsList);
                }
            } catch (error) {
                console.error('Error cargando reportes:', error);
            }
        }

        async function loadUsers() {
            try {
                const res = await (window.fetchJSON ? await window.fetchJSON('/api/admin/users') : fetch(CONFIG.API_URL + '/admin/users', {
                    headers: { 'Authorization': 'Bearer ' + await Auth.getToken() }
                }).then(r => r.json()));
                
                console.log('Respuesta de usuarios:', res);
                
                if (res && res.success) {
                    // La respuesta puede tener estructura: {success: true, data: {data: [...], count: N}}
                    const usersList = res.data?.data || res.data || [];
                    console.log('Lista de usuarios:', usersList);
                    
                    if (window.renderUsers) {
                        window.renderUsers(usersList);
                    } else {
                        console.log('Users:', usersList);
                        // Fallback: mostrar tabla b√°sica
                        const container = document.getElementById('users-list');
                        if (container && usersList.length > 0) {
                            container.innerHTML = `
                                <table class="users-table">
                                    <thead>
                                        <tr>
                                            <th>Nombre</th>
                                            <th>Email</th>
                                            <th>Rol</th>
                                            <th>Strikes</th>
                                            <th>Activo</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${usersList.map(u => `
                                            <tr>
                                                <td>${u.first_name} ${u.last_name}</td>
                                                <td>${u.email}</td>
                                                <td>${u.role}</td>
                                                <td>${u.strikes || 0}</td>
                                                <td>${u.is_active ? 'S√≠' : 'No'}</td>
                                                <td>
                                                    <button class="btn btn-danger small">Ban</button>
                                                    <button class="btn btn-success small">Desban</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            `;
                        }
                    }
                }
            } catch (error) {
                console.error('Error cargando usuarios:', error);
                const container = document.getElementById('users-list');
                if (container) {
                    container.innerHTML = `<div class="text-red-500">Error al cargar usuarios: ${error.message}</div>`;
                }
            }
        }

        // Inicializar el dashboard
        document.addEventListener('DOMContentLoaded', async function() {
            // Verificar autenticaci√≥n primero
            if (!isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }
            
            // Esperar a que el header se cargue completamente
            setTimeout(() => {
                // Configurar men√∫ de admin (modificar opciones)
                console.log('Configurando men√∫ de admin...');
                console.log('configureAdminMenu disponible?', typeof configureAdminMenu);
                
                if (typeof configureAdminMenu === 'function') {
                    configureAdminMenu();
                } else {
                    // Si no est√° disponible a√∫n, configurar manualmente
                    console.log('Configurando opciones manualmente...');
                    const homeOption = document.getElementById('menuHomeOption');
                    const favOption = document.getElementById('menuFavoritesOption');
                    const adminOptions = document.querySelectorAll('.admin-only');
                    const ownerOptions = document.querySelectorAll('.owner-only');
                    
                    if (homeOption) {
                        // Cambiar a "Administrar"
                        const span = homeOption.querySelector('span');
                        if (span) span.textContent = 'Administrar';
                        homeOption.href = 'dashboard-admin.html';
                        homeOption.classList.remove('hidden');
                        homeOption.classList.add('block');
                        console.log('Inicio cambiado a Administrar');
                    }
                    if (favOption) {
                        favOption.classList.add('hidden');
                        console.log('Favoritos ocultado');
                    }
                    adminOptions.forEach(opt => {
                        opt.classList.add('hidden');
                        opt.classList.remove('block');
                    });
                    ownerOptions.forEach(opt => {
                        opt.classList.add('hidden');
                        opt.classList.remove('block');
                    });
                    console.log('Opciones admin/owner ocultadas');
                }
            }, 100);
            
            // Cargar todas las secciones
            await Promise.all([
                loadStats(),
                loadReports(),
                loadUsers(),
                loadRestaurants()
            ]);
        });
    </script>
 </body>
 </html>

